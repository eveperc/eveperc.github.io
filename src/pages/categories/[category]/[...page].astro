---
import Layout from "../../../layouts/Layout.astro";
import { Breadcrumbs } from "../../../components/Breadcrumbs";
import Articles from "../../../components/Articles.astro";
import { LowContent } from "../../../components/LowContent";
import { Pagination } from "../../../components/Pagination";
import {Category} from "../../../components/Category";
import {categoryContent} from "../../../lib/category";

import { newtClient } from "../../../lib/newt";
import type { Article } from "../../../lib/newt";
import type { GetStaticPathsOptions } from "astro";

export const getStaticPaths = async ({ paginate }: GetStaticPathsOptions) => {
  const { items: categoryData } = await newtClient.getContents<Article>({
    appUid: "blog",
    modelUid: "article",
    query: {
      select: ["category"],
    },
  });
  const { items: articles } = await newtClient.getContents<Article>({
    appUid: "blog",
    modelUid: "article",
    query: {
      select: ["title", "slug", "category", "coverImage", "updatedAt"],
    },
  });
  return categoryData.map((categoryContent: Article) => {
    const postsContents: Article[] = articles.filter(
      (item: Article) => item.category.slug === categoryContent.category.slug
    );
    return paginate(postsContents, {
      params: {
        category: categoryContent.category.slug,
      },
      pageSize: 9,
    });
  });
};

const { category } = Astro.params;
const { page } = Astro.props;
const data: Article[] = page.data;
const url = import.meta.env.SITE_URL;
---

<Layout id="category" title="NeoEveLog" description={category ? category : ""}>
  <Breadcrumbs title={category ? category : ""} />
  <Category url={url} data={categoryContent}/>
  <Articles articles={data} />
  <LowContent>
    <Pagination page={page} />
  </LowContent>
</Layout>
